<?xml version="1.0" encoding="UTF-8"?>
<?xspec-test min-xmlcalabash-version=3.0.30?>
<x:description xmlns:s="x-urn:test:xproc:steplibrary"
    xmlns:thd="http://www.jenitennison.com/xslt/xspec/helper/document-nodes"
    xmlns:x="http://www.jenitennison.com/xslt/xspec" xmlns:wrap="urn:x-xspec:common:wrap"
    xproc="library.xpl">

    <x:helper stylesheet="../../../tutorial/helper/document-nodes/test-helper-documents.xsl"/>

    <x:scenario label="Request 0 documents">
        <x:call step="s:output-port-sequence-true">
            <x:option name="num" select="0"/>
        </x:call>
        <!-- Boolean @test with scoped $x:result -->
        <x:expect label="Output port is empty" port="xproc-result" test="empty($x:result)"
            result-type="empty-sequence()"/>
    </x:scenario>
    <x:scenario label="Request 1 document">
        <x:call step="s:output-port-sequence-true">
            <x:option name="num" select="1"/>
        </x:call>
        <!-- Match scoped $x:result with no filtering -->
        <x:expect label="Output port has 1 document" port="xproc-result" select="/"
            result-type="document-node(element(output-document))">
            <output-document/>
        </x:expect>
        <x:expect label="that can be verified by omitting both @test and select='/'"
            port="xproc-result" result-type="document-node(element(output-document))">
            <output-document/>
        </x:expect>

        <!-- Scoped $x:result is context item for x:expect/@test -->
        <x:expect label="and its outermost element's local name is 'output-document'"
            port="xproc-result" test="local-name(child::*)" select="'output-document'"/>
        <x:expect label="Same thing with dot syntax" port="xproc-result"
            test="local-name(./child::*)" select="'output-document'"/>
        <x:expect label="Same thing with $x:result" port="xproc-result"
            test="local-name($x:result/child::*)" select="'output-document'"/>
    </x:scenario>
    <x:scenario label="Request 2 documents">
        <x:call step="s:output-port-sequence-true">
            <x:option name="num" select="2"/>
        </x:call>
        <x:expect
            label="Output port has 2 documents, each with output-document as outermost element"
            port="xproc-result" result-type="document-node(element(output-document))+"
            test="$x:result => count()" select="2"/>
        <x:expect port="xproc-result" select="/node() => thd:wrap-each()">
            <x:label>x:expect[@port][not(@test)] with two child elements must wrap them or else they
                will be in a single document node instead of two</x:label>
            <output-document/>
            <output-document/>
        </x:expect>
        <!-- Next, select="/" is needed because x:expect uses @test to filter $x:result -->
        <x:expect label="x:expect can individually verify the first document" port="xproc-result"
            test="$x:result[1]" select="/">
            <output-document/>
        </x:expect>
        <x:expect label="and the second document" port="xproc-result" test="$x:result[2]" select="/">
            <output-document/>
        </x:expect>
    </x:scenario>
</x:description>
