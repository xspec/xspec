<?xml version="1.0" encoding="UTF-8"?>
<x:description xmlns:local="urn:x-xspec:compiler:xproc:compile:get-step-inputs:local"
    xmlns:loc-p="x-urn:local-xproc-names" xmlns:loc-t="x-urn:local-xspec-names"
    xmlns:p="http://www.w3.org/ns/xproc" xmlns:x="http://www.jenitennison.com/xslt/xspec"
    xmlns:xs="http://www.w3.org/2001/XMLSchema" stylesheet="../src/compiler/compile-xproc-tests.xsl">

    <x:param name="initial-document" href="xproc/cases/two-inputs-no-option-one-output.xspec"
        select="/"/>

    <x:scenario label="Test local:gather-steps mode">
        <x:scenario label="in p:library without imports">
            <x:context mode="local:gather-steps" select="/">
                <p:library>
                    <p:declare-step type="loc-p:step1">
                        <p:input port="aux1"/>
                        <p:input port="source" primary="true"/>
                        <p:input port="aux2" use-when="true()"/>
                        <p:output port="result"/>
                        <p:option name="loc-p:opt"/>
                        <p:declare-step type="loc-p:substep">
                            <p:input port="source"/>
                            <p:output port="result"/>
                            <p:identity/>
                        </p:declare-step>
                        <p:identity/>
                    </p:declare-step>
                    <p:declare-step type="loc-p:step2" use-when="true()">
                        <p:input port="source" sequence="true"/>
                        <p:output port="result"/>
                        <p:identity/>
                    </p:declare-step>
                </p:library>
            </x:context>
            <x:expect select="/">
                <x:label>p:library containing flat list of simplified child steps, each with
                    URI-qualified step type</x:label>
                <p:library>
                    <p:declare-step type="Q{{x-urn:local-xproc-names}}step1">
                        <p:input port="aux1"/>
                        <p:input port="source"/>
                        <p:input port="aux2" use-when="true()"/>
                    </p:declare-step>
                    <p:declare-step type="Q{{x-urn:local-xproc-names}}step2" use-when="true()">
                        <p:input port="source"/>
                    </p:declare-step>
                </p:library>
            </x:expect>
            <x:expect label="Substeps are not included."
                test="empty($x:result/descendant::p:declare-step[ends-with(@type,'}substep')])"/>
        </x:scenario>
        <x:scenario label="in p:declare-step without imports">
            <x:context mode="local:gather-steps" select="/">
                <p:declare-step type="loc-p:pipeline">
                    <p:input port="aux1"/>
                    <p:input port="source" primary="true"/>
                    <p:input port="aux2"/>
                    <p:output port="result"/>
                    <p:option name="loc-p:opt"/>
                    <p:declare-step type="loc-p:substep">
                        <p:input port="source" sequence="true"/>
                        <p:output port="result"/>
                        <p:identity/>
                    </p:declare-step>
                    <p:identity/>
                </p:declare-step>
            </x:context>
            <x:expect select="/">
                <x:label>p:declare-step as a simplified step with URI-qualified step type</x:label>
                <p:declare-step type="Q{{x-urn:local-xproc-names}}pipeline">
                    <p:input port="aux1"/>
                    <p:input port="source"/>
                    <p:input port="aux2"/>
                </p:declare-step>
            </x:expect>
            <x:expect label="Substeps are not included."
                test="empty($x:result/descendant::p:declare-step[ends-with(@type,'substep')])"/>
        </x:scenario>
        <x:scenario label="with import (circular, in fact)">
            <x:context mode="local:gather-steps" href="xproc/cases/circular-import1.xpl"/>
            <x:expect select="/">
                <x:label>All the steps in the library and its imports, recursively, with p:library
                    parents retained for imports</x:label>
                <p:library>
                    <p:declare-step type="Q{{x-urn:test:xproc:steplibrary}}step1">
                        <p:input port="source"/>
                    </p:declare-step>
                    <p:library>
                        <p:declare-step type="Q{{x-urn:test:xproc:steplibrary}}step2">
                            <p:input port="source"/>
                        </p:declare-step>
                    </p:library>
                </p:library>
            </x:expect>
        </x:scenario>
    </x:scenario>

    <x:scenario label="Test x:get-step-inputs function">
        <x:scenario label="Calling a step with two input ports">
            <x:variable name="loc-t:parent-scenario" as="element(x:scenario)"
                select="$initial-document/x:description/x:scenario[1]/x:scenario[1]"/>
            <x:call function="x:get-step-inputs">
                <x:param select="$loc-t:parent-scenario/x:call"/>
                <x:param select="$loc-t:parent-scenario"/>
            </x:call>
            <x:expect label="returns the port declarations with subset of attributes"
                as="element(p:input)+">
                <p:input port="in1"/>
                <p:input port="in2"/>
            </x:expect>
        </x:scenario>
        <x:scenario label="Known step but unknown port name in x:input">
            <x:variable name="loc-t:parent-scenario" as="element(x:scenario)"
                href="xproc/compiler-error-cases/unknown-port.xspec"
                select="//x:scenario[@label eq 'Unknown input']"/>
            <x:call function="x:get-step-inputs">
                <x:param select="$loc-t:parent-scenario/x:call"/>
                <x:param select="$loc-t:parent-scenario"/>
            </x:call>
            <x:expect label="returns the port declarations as usual" as="element(p:input)">
                <p:input port="source"/>
            </x:expect>
        </x:scenario>
        <x:scenario label="Step whose input port declaration has use-when">
            <x:variable name="loc-t:parent-scenario" as="element(x:scenario)"
                href="xproc/cases/warning-cases.xspec"
                select="//x:scenario[@label eq 'Step with use-when on p:input']"/>
            <x:call function="x:get-step-inputs">
                <x:param select="$loc-t:parent-scenario/x:call"/>
                <x:param select="$loc-t:parent-scenario"/>
            </x:call>
            <x:expect label="returns the port declarations with use-when preserved"
                as="element(p:input)+">
                <p:input port="aux" use-when="$aux-port"/>
                <p:input port="source"/>
            </x:expect>
        </x:scenario>
    </x:scenario>

    <x:scenario label="Test x:UQName-of-step function">
        <x:scenario label="on step declaration">
            <x:scenario label="with colon in step type">
                <x:call function="x:UQName-of-step">
                    <x:param href="xproc/cases/library.xpl"
                        select="/p:library/p:declare-step[@type='s:step-with-substep']/@type"/>
                </x:call>
                <x:expect label="returns URI-qualified name"
                    select="'Q{x-urn:test:xproc:steplibrary}step-with-substep'"/>
            </x:scenario>
            <x:scenario label="without colon in step type">
                <x:call function="x:UQName-of-step">
                    <x:param select="/*/@type">
                        <p:declare-step type="Q{{x-urn:test:xproc:steplibrary}}step"/>
                    </x:param>
                </x:call>
                <x:expect label="returns string value of @type"
                    select="'Q{x-urn:test:xproc:steplibrary}step'"/>
            </x:scenario>
        </x:scenario>
        <x:scenario label="on XSpec call">
            <x:scenario label="with colon in step type">
                <x:call function="x:UQName-of-step">
                    <x:param href="xproc/cases/no-input-no-option-one-output.xspec"
                        select="//x:scenario[@label='No input, no option, one output']/x:call/@step"
                    />
                </x:call>
                <x:expect label="returns URI-qualified name"
                    select="'Q{x-urn:test:xproc:steplibrary}no-input-no-option-one-output'"/>
            </x:scenario>
            <x:scenario label="without colon in step type">
                <x:call function="x:UQName-of-step">
                    <x:param href="xproc/cases/no-input-no-option-one-output.xspec"
                        select="//x:scenario[@label='Q{} notation in x:call/@step']/x:call/@step"/>
                </x:call>
                <x:expect label="returns string value of @step"
                    select="'Q{x-urn:test:xproc:steplibrary}no-input-no-option-one-output'"/>
            </x:scenario>
        </x:scenario>
    </x:scenario>
</x:description>
